<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hồ sơ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>
  <body>
    <header><%- include("./header.ejs") %></header>
    <main>
      <form id="update" class="space-y-6 max-w-md mx-auto my-20">
        <div>
          <label class="block text-md font-medium text-gray-700 mb-2">Họ và tên </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-user text-gray-400"></i>
            </div>
            <input
              type="text"
              id="name"
              class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              value="<%= customer.name %>"
              disabled
            />
          </div>
        </div>
        <div>
          <label class="block text-md font-medium text-gray-700 mb-2">Số điện thoại</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-phone text-gray-400"></i>
            </div>
            <input
              type="text"
              id="phone"
              class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              value="<%= customer.phone %>"
              disabled
            />
          </div>
        </div>
        <div>
          <label class="block text-md font-medium text-gray-700 mb-2">Địa chỉ </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-location-dot text-gray-400"></i>
            </div>
            <select
              id="address"
              disabled
              class="text-center block w-full pl-5 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
            >
              <option value="<%= customer.address %>" selected><%= customer.address %></option>
            </select>
          </div>
        </div>
        <p id="error" class="text-sm text-red-500 font-medium text-center"></p>
        <p id="success" class="text-sm text-green-500 font-medium text-center"></p>
        <div class="flex gap-3">
          <button
            id="edit"
            class="w-full bg-gradient-to-r from-red-400 to-blue-500 text-white py-3 rounded-lg font-semibold hover:from-red-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform transition duration-200 hover:scale-105"
          >
            Chỉnh sửa
          </button>
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform transition duration-200 hover:scale-105"
          >
            Cập nhật
          </button>
        </div>
      </form>
    </main>
    <footer><%- include("./footer.ejs") %></footer>
  </body>
  <script>
    const address = [
      'An Giang',
      'Bắc Ninh',
      'Cà Mau',
      'Cao Bằng',
      'Cần Thơ',
      'Đà Nẵng',
      'Đắk Lắk',
      'Điện Biên',
      'Đồng Nai',
      'Đồng Tháp',
      'Gia Lai',
      'Hà Nội',
      'Hà Tĩnh',
      'Hải Phòng',
      'Huế',
      'Hưng Yên',
      'Khánh Hòa',
      'Lai Châu',
      'Lâm Đồng',
      'Lạng Sơn',
      'Lào Cai',
      'Nghệ An',
      'Ninh Bình',
      'Phú Thọ',
      'Quảng Ngãi',
      'Quảng Ninh',
      'Quảng Trị',
      'Sơn La',
      'Tây Ninh',
      'Thái Nguyên',
      'Thanh Hóa',
      'Hồ Chí Minh City',
      'Tuyên Quang',
      'Vĩnh Long',
    ];
    address.forEach((v) => {
      let option = document.createElement('option');
      option.value = v;
      option.text = v;
      document.getElementById('address').appendChild(option);
    });
    document.getElementById('edit').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('name').removeAttribute('disabled');
      document.getElementById('phone').removeAttribute('disabled');
      document.getElementById('address').removeAttribute('disabled');
    });
    document.getElementById('update').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = '<%= customer.id %>';
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value;
      if (!name || !phone || !address) {
        document.getElementById('error').innerText = 'Vui lòng điền đầy đủ thông tin.';
        return;
      }
      if (!/^\d{10}$/.test(phone) || !phone.startsWith('0')) {
        document.getElementById('error').innerText = 'Số điện thoại không hợp lệ.';
        return;
      }
      try {
        const res = await fetch(`/${id}/profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, phone, address }),
        });
        const result = await res.json();
        if (res.ok) {
          document.getElementById('error').innerText = '';
          document.getElementById('success').innerText = result.success;
          document.getElementById('name').setAttribute('disabled', 'true');
          document.getElementById('phone').setAttribute('disabled', 'true');
          document.getElementById('address').setAttribute('disabled', 'true');
        } else {
          document.getElementById('success').innerText = '';
          document.getElementById('error').innerText = result.error;
        }
      } catch (error) {
        document.getElementById('error').innerText = 'Đã xảy ra lỗi. Vui lòng thử lại.';
      }
    });
  </script>
</html>
